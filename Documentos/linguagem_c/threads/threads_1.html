<!DOCTYPE HTML PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en"><head>



 	<title>CES33 - Sistemas Operacionais: Bruno</title>
 	
 		 	<script type="text/javascript" src="threads_1_arquivos/init.js"></script>
 	<script type="text/javascript">
 		var URL_HOST = 'www.wikidot.com';
		var URL_DOMAIN = 'wikidot.com';
 		// global request information
 		
 		var WIKIREQUEST = {};
 		WIKIREQUEST.info = {};
 		
 		WIKIREQUEST.info.domain = "ces33.wikidot.com";
 		WIKIREQUEST.info.siteId = 107795;
 		WIKIREQUEST.info.categoryId = 607250;
 		WIKIREQUEST.info.themeId = 7;
 		WIKIREQUEST.info.requestPageName = "relas:bruno";
 		OZONE.request.timestamp = 1249149991;
 		OZONE.request.date = new Date();
 		WIKIREQUEST.info.lang = 'en';
 		 		WIKIREQUEST.info.pageUnixName = "relas:bruno";
 		WIKIREQUEST.info.pageId = 3391742;
 		 		WIKIREQUEST.info.lang = "en";
 		OZONE.lang = "en";
// 		window.onload = WikidotInit();
 	</script>
 	
 	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
         	<meta http-equiv="content-language" content="en">
 		<script type="text/javascript" src="threads_1_arquivos/WIKIDOT.js"></script>
	
	
	
   	
	<style type="text/css">
body {
  background-position: center 24px;
}
</style>
<style type="text/css" id="internal-style"> 
 @import url(http://static.wikidot.com/v--74/common--modules/css/wiki/pagestagcloud/PagesTagCloudModule.css);
@import url(http://static.wikidot.com/v--74/common--modules/css/monetize/textlinkads/MonetizeTextLinkAdsModule.css);
 
 
   		
   		   			@import url(http://static.wikidot.com/v--74/common--theme/base/css/style.css?0);
   		   			@import url(http://static.wikidot.com/v--74/common--theme/flannel-ocean/css/style.css?0);
   		   		
     </style>
    
    <link rel="shortcut icon" href="http://ces33.wikidot.com/local--favicon/favicon.gif">
    <link rel="icon" type="image/gif" href="http://ces33.wikidot.com/local--favicon/favicon.gif">
    
            <link rel="alternate" type="application/wiki" title="Edit this page!" href="javascript:WIKIDOT.page.listeners.editClick()">
    
<script type="text/javascript" src="threads_1_arquivos/NewPageHelperModule.js"></script></head><body id="html-body">
  <div id="navi-bar">
  <a class="logo" href="http://www.wikidot.com/">
    <span>Wikidot.com</span>
  </a>
  
  
  
  <div class="new-site">
    <form method="get" action="http://www.wikidot.com/new-site">
      <input class="text empty" name="address" value="site-name" type="text">.wikidot.com
    </form>
  </div>
  
    <div class="share">
    <span>Share on</span>
    <a class="twitter" target="_blank" rel="nofollow" href="http://twitter.com/home?status=CES33%20-%20Sistemas%20Operacionais%3A%20Bruno+http%3A%2F%2Fces33.wikidot.com%2Frelas%3Abruno" title="Share on Twitter"><img src="threads_1_arquivos/twitter.png" alt="twitter"></a>  
    <a class="facebook" target="_blank" rel="nofollow" href="http://www.facebook.com/share.php?u=http%3A%2F%2Fces33.wikidot.com%2Frelas%3Abruno&amp;t=CES33%20-%20Sistemas%20Operacionais%3A%20Bruno" title="Share on Facebook"><img src="threads_1_arquivos/facebook.gif" alt="Facebook"></a>  
    <a class="delicious" target="_blank" rel="nofollow" href="http://delicious.com/save" title="Share on Delicious"><img src="threads_1_arquivos/delicious.png" alt="Delicious"></a>
    <a class="digg" target="_blank" rel="nofollow" href="http://digg.com/submit?url=http%3A%2F%2Fces33.wikidot.com%2Frelas%3Abruno&amp;title=CES33%20-%20Sistemas%20Operacionais%3A%20Bruno" title="Post to Digg"><img src="threads_1_arquivos/digg.png" alt="Digg"></a>
    <a class="reddit" href="http://www.reddit.com/submit?url=http%3A%2F%2Fces33.wikidot.com%2Frelas%3Abruno" rel="nofollow" target="_blank" title="Post to Reddit"><img src="threads_1_arquivos/reddit.png" alt="Reddit" border="0"></a>
    <a class="stumbleupon" href="http://www.stumbleupon.com/submit?url=http%3A%2F%2Fces33.wikidot.com%2Frelas%3Abruno" rel="nofollow" target="_blank" title="Post to StumbleUpon"><img src="threads_1_arquivos/stumble.png" alt="Reddit" border="0"></a>
  </div>
    
      <div class="action-buttons">
      <a href="javascript:;" onclick="WIKIDOT.page.listeners.editClick(event)" title="Click here to edit contents of this page.">Edit</a>
      <a href="javascript:;" onclick="WIKIDOT.page.listeners.historyClick(event)" title="Check out how this page has evolved in the past.">History</a>
            <a href="javascript:;" onclick="WIKIDOT.page.listeners.editTags(event)" title="Edit tags for this page.">Tags</a>
      <a href="javascript:;" onclick="WIKIDOT.page.listeners.viewSourceClick(event)" title="View wiki source for this page without editing.">Source</a>
          </div>
    
  <a class="random-site" href="http://ces33.wikidot.com/random-site.php" title="Go to a random Wikidot site.">Explore »</a>
    </div>
<div id="navi-bar-shadow">&nbsp;</div>


<script type="text/javascript">
  $j(function(){
    var uri = window.location.href;
    var title = document.title
    
    $j('#navi-bar .share a').each(function(){
      $t = $j(this);
      var u = $t.attr('href');
      u = u.replace(/TITLE/, encodeURIComponent(title)).replace(/URI/, encodeURIComponent(uri));
      $t.attr('href', u);
    });
    
    $j('#navi-bar .share .facebook').click(function(e){
      window.open('http://www.facebook.com/sharer.php?u='+encodeURIComponent(uri)+'&t='+encodeURIComponent(title),'sharer','toolbar=0,status=0,width=626,height=436');
      e.preventDefault();
    });
    $j('#navi-bar .share .delicious').click(function(e){
      window.open('http://delicious.com/save?v=5&amp;noui&amp;jump=close&amp;url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title), 'delicious','toolbar=no,width=550,height=550');
      e.preventDefault();
    });
  });
  
	$j('#navi-bar .new-site form').submit(function(e){
	  e.preventDefault();
	  var $i = $j('#navi-bar .new-site form input.text');
	  if($i.hasClass('empty')){
	    	var w = new OZONE.dialogs.ErrorDialog();
  			w.content = "You need to enter a valid web address for your new wiki.";
  			w.show();
  			return;
    }
    var siteName = $i.attr('value');
    siteName = siteName.replace(/^\s+/, '').replace(/\s+$/,'');
		// validate a bit
		//if(siteName.length <3){
		//	var w = new OZONE.dialogs.ErrorDialog();
		//	w.content = "You need to provide the web address for you wiki and it should be at least 3 characters long.";
		//	w.show();
		//	return;
		//}
		var p = {};
		p.action = 'wiki/special/NewWikiWidgetAction';
		p.event = 'newWiki';
		p.siteName = siteName;
		OZONE.ajax.requestModule(null, p, function(r){
		  if(r.status == 'site_exists'){
		    window.location.href = 'http://' + siteName + '.' + URL_DOMAIN;
		    return;
		  }
		  if(!WIKIDOT.utils.handleError(r)) {return;}
  		// seems fine.
  		window.location.href='http://'+URL_HOST+'/new-site/address/'+r.unixName;
		});
	});
	$j('#navi-bar .new-site form input.text').focus(function(){
	  var $t = $j(this);
	  if($t.hasClass('empty')){
	    $t.removeClass('empty');
	    $t.attr('value', '');
	  }
	});
	
</script>


  <div id="container-wrap-wrap">
	<div id="container-wrap">
		<div id="container">
		  	<div id="header">
		  		<h1><a href="http://ces33.wikidot.com/"><span>CES33 - Sistemas Operacionais</span></a></h1>
		  				  			<h2><span>ITA</span></h2>
		  				  		
		  		<!-- google_ad_section_start(weight=ignore) -->
		  		
		  		<div id="search-top-box">
		  			<form id="search-top-box-form" action="dummy">
			  			<input id="search-top-box-input" class="text empty" size="15" name="query" value="search this site" onfocus="if(YAHOO.util.Dom.hasClass(this, 'empty')){YAHOO.util.Dom.removeClass(this,'empty'); this.value='';}" type="text"><input class="button" name="search" value="search" type="submit">
				 	</form>
	  			</div>
		  		
		  					  		<div id="top-bar">
			  			

<ul><li><a href="javascript:;">aulas</a><ul><li><a class="newpage" href="http://ces33.wikidot.com/slides">slides</a></li></ul></li><li><a href="javascript:;">labs</a><ul><li><a href="http://ces33.wikidot.com/instrucoes">instruções</a></li><li><a href="http://ces33.wikidot.com/relatorios">relatórios</a></li></ul></li><li><a class="newpage" href="http://ces33.wikidot.com/contato">contato</a></li></ul>

			  		</div>
		  				  		<div id="login-status"><a href="http://www.wikidot.com/auth:newaccount?origUrl=http%3A%2F%2Fces33.wikidot.com%2Frelas%3Abruno">create account</a> or <a href="http://www.wikidot.com/auth:login?origUrl=http%3A%2F%2Fces33.wikidot.com%2Frelas%3Abruno">login</a> </div>
		  		<div id="header-extra-div-1"><span></span></div><div id="header-extra-div-2"><span></span></div><div id="header-extra-div-3"><span></span></div>
		  	</div>
		  	
			<div id="content-wrap">
									<div id="side-bar">
															

												

<h2><span>Ações</span></h2><ul><li><a href="http://ces33.wikidot.com/start">Página Inicial</a></li></ul><ul><li><a href="http://ces33.wikidot.com/system:join">Cadastro no Wiki</a></li><li><a href="http://ces33.wikidot.com/system:members">Lista de Membros</a></li><li><a href="http://ces33.wikidot.com/system:join">Inscrever na Wiki</a></li></ul><ul><li><a href="http://ces33.wikidot.com/system:recent-changes">Recent changes</a></li><li><a href="http://ces33.wikidot.com/system:list-all-pages">List all pages</a></li></ul><ul><li><a href="http://ces33.wikidot.com/admin:manage">Site Manager</a></li></ul><h2><span>Page tags</span></h2>
	<p>
		It seems you have no tags attached to pages. To attach a tag simply click on the <em>tags</em> 
		button at the bottom of any page.	</p>

<h2><span>Add a new page</span></h2>

<div class="new-page-box" style="margin: 1em 0pt; text-align: center;">
	<form action="dummy.html" method="get" onsubmit="WIKIDOT.modules.NewPageHelperModule.listeners.create(event)">
		<input class="text" name="pageName" size="15" maxlength="60" style="margin: 1px;" type="text"><input class="button" value="new page" style="margin: 1px;" type="submit">
												
	</form>
</div>

<p style="text-align: center;"><span style="font-size: 80%;"><a href="http://ces33.wikidot.com/nav:side">edit this panel</a></span></p>

															

						
					</div>
								
				<!-- google_ad_section_end -->
				
				<div id="main-content">
					<div id="action-area-top"></div>
					
					<!-- google_ad_section_start -->
					
										<div id="page-title">
					Bruno					</div>
															
															
				<div style="margin: 20px auto; display: block; float: none; visibility: visible; text-align: center;">

<script type="text/javascript"><!--
google_ad_client = "pub-8290351116363959";
/* 468x60, created 2/11/09, 2 */
google_ad_slot = "1709944131";
google_ad_width = 468;
google_ad_height = 60;
//-->
</script>
<script type="text/javascript" src="threads_1_arquivos/show_ads.js">
</script><script src="threads_1_arquivos/expansion_embed.js"></script><script src="threads_1_arquivos/test_domain.js"></script><script>google_protectAndRun("ads_core.google_render_ad", google_handleError, google_render_ad);</script><ins style="border: medium none ; margin: 0pt; padding: 0pt; display: inline-table; height: 60px; position: relative; visibility: visible; width: 468px;"><ins style="border: medium none ; margin: 0pt; padding: 0pt; display: block; height: 60px; position: relative; visibility: visible; width: 468px;"><iframe allowtransparency="true" hspace="0" id="google_ads_frame1" marginheight="0" marginwidth="0" name="google_ads_frame" src="threads_1_arquivos/ads.html" style="left: 0pt; position: absolute; top: 0pt;" vspace="0" scrolling="no" width="468" frameborder="0" height="60"></iframe></ins></ins>

</div>
				
				

										
					<div id="page-content">
					
															

												 	
					 										

												
												

<h1 id="toc0"><span>Laboratório de CES-33</span></h1>
<h2 id="toc1"><span>Instituto Tecnológico de Aeronáutica</span></h2>
<p>Professor: Edgar Toshiro Yano<br>
Aluno: Bruno César Alves<br>
Data: 08/05/2009</p>
<h2 id="toc2"><span>Objetivo:</span></h2>
<p>Este laboratório tem o intuito de explorar o uso de semáforos,
threads, mutex e processos no sistema operacional LINUX. Para tanto,
foram desenvolvidas algumas aplicações em liguagem c da solução de
alguns problemas típicos:<br>
- Problema dos produtores e consumidores usando pipe<br>
- Problema dos filósofos jantando<br>
- Problema dos leitores e escritores<br>
- Problema do barbeiro adormecido<br>
- Problema do banheiro (Ex1 - Prova de CES-33 / ITA-2009)<br>
- Problema das mensagens (Ex7 - Prova de CES-33 / ITA-2009)<br>
Para a execução das aplicação, foi utilizado o gcc no terminal do LINUX.</p>
<h2 id="toc3"><span>Soluções:</span></h2>
<h3 id="toc4"><span>Problema dos produtores e consumidores usando pipe</span></h3>
<p>O problema dos produtores e consumidores trata do envio e recepção de dados a partir de um <em>buffer</em>. Para a solução desse problemas foi criada uma aplicação que utiliza pipes que comunicam processos criados com <em>fork()</em>.</p>
<p>Segue o código da aplicação que soluciona o problema para varios produtores e receptores:</p>
<div class="code">
<div class="hl-main">
<pre><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">string.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">READ</span><span class="hl-code">          </span><span class="hl-number">0</span><span class="hl-code">             </span><span class="hl-comment">//indice de leitura da saida do pipe</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">WRITE</span><span class="hl-code">        </span><span class="hl-number">1</span><span class="hl-code">             </span><span class="hl-comment">//indice de escrita da entrada do pipe</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">PRODUTORES</span><span class="hl-code">   </span><span class="hl-number">15</span><span class="hl-code">             </span><span class="hl-comment">//define numero de produtores</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">LEITORES</span><span class="hl-code">     </span><span class="hl-number">8</span><span class="hl-code">            </span><span class="hl-comment">//define numero de leitores</span><span class="hl-code">
 
</span><span class="hl-types">char</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-brackets">[]</span><span class="hl-code"> = </span><span class="hl-quotes">"</span><span class="hl-string">Hello World</span><span class="hl-quotes">"</span><span class="hl-code">;
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-code"> </span><span class="hl-brackets">()</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">fd</span><span class="hl-code"> </span><span class="hl-brackets">[</span><span class="hl-number">2</span><span class="hl-brackets">]</span><span class="hl-code">,</span><span class="hl-identifier">i</span><span class="hl-code">,</span><span class="hl-identifier">j</span><span class="hl-code">;
    </span><span class="hl-identifier">pipe</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">fork</span><span class="hl-code"> </span><span class="hl-brackets">()</span><span class="hl-code"> == </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code"> 
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">for</span><span class="hl-brackets">(</span><span class="hl-identifier">i</span><span class="hl-code">=</span><span class="hl-number">0</span><span class="hl-code">;</span><span class="hl-identifier">i</span><span class="hl-code">&lt;</span><span class="hl-identifier">PRODUTORES</span><span class="hl-code">;</span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">close</span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-brackets">[</span><span class="hl-identifier">READ</span><span class="hl-brackets">])</span><span class="hl-code">; </span><span class="hl-mlcomment">/* Close unused end */</span><span class="hl-code">
            </span><span class="hl-identifier">write</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-brackets">[</span><span class="hl-identifier">WRITE</span><span class="hl-brackets">]</span><span class="hl-code">,</span><span class="hl-identifier">mensagem</span><span class="hl-code">, </span><span class="hl-identifier">strlen</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">mensagem</span><span class="hl-brackets">)</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">; </span><span class="hl-mlcomment">/* include NULL*/</span><span class="hl-code">
            </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Enviei uma mensagem para meu processo pai</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">close</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-brackets">[</span><span class="hl-identifier">WRITE</span><span class="hl-brackets">])</span><span class="hl-code">; </span><span class="hl-mlcomment">/* Close used end*/</span><span class="hl-code">
            </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">else</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-reserved">for</span><span class="hl-brackets">(</span><span class="hl-identifier">j</span><span class="hl-code">=</span><span class="hl-number">0</span><span class="hl-code">;</span><span class="hl-identifier">j</span><span class="hl-code">&lt;</span><span class="hl-identifier">LEITORES</span><span class="hl-code">;</span><span class="hl-identifier">j</span><span class="hl-code">++</span><span class="hl-brackets">){</span><span class="hl-code">
            </span><span class="hl-types">char</span><span class="hl-code"> </span><span class="hl-identifier">message</span><span class="hl-brackets">[</span><span class="hl-number">15</span><span class="hl-brackets">]</span><span class="hl-code">;
            </span><span class="hl-identifier">close</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-brackets">[</span><span class="hl-identifier">WRITE</span><span class="hl-brackets">])</span><span class="hl-code">; </span><span class="hl-mlcomment">/* Close unused end */</span><span class="hl-code">
            </span><span class="hl-identifier">read</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-brackets">[</span><span class="hl-identifier">READ</span><span class="hl-brackets">]</span><span class="hl-code">, </span><span class="hl-identifier">message</span><span class="hl-code">, </span><span class="hl-number">15</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Recebi essa mensagem de meu filho: %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-code">,</span><span class="hl-identifier">message</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">close</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-identifier">fd</span><span class="hl-brackets">[</span><span class="hl-identifier">READ</span><span class="hl-brackets">])</span><span class="hl-code">; </span><span class="hl-mlcomment">/* Close used end */</span><span class="hl-code"> 
            </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-number">2</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span>
</pre></div>
</div>
<p>A execução da aplicação gerou o seguinte resultado:</p>
<div class="image-container aligncenter"><a href="http://ces33.wikidot.com/local--files/relas:bruno/pipe"><img src="threads_1_arquivos/medium.jpg" alt="pipe" class="image"></a></div>
<h3 id="toc5"><span>Problema dos filósofos jantando</span></h3>
<div class="image-container aligncenter"><img src="threads_1_arquivos/Philosphers.jpg" alt="Philosphers.jpg" class="image"></div>
<p>O primeiro problema trata de cinco filósofos que podem comer ou
pensar, porém, de acordo com a disposição dos garfos e pratos na figura
acima, um filósofo só pode se alimentar quando seus vizinhos não estão
comendo. O problema principal, na computação, é a questão da disputa
entre filósofos diferentes na tentativa de pegar o mesmo garfo.<br>
O codigo abaixo mostra a solução do problema, para a implementação da
solução, cada filosofo foi tratado como uma thread e os acessos aos
pratos foram controlados por semáforos. O semáforo mutex é usado para
criar exclusão mutua de forma que os filosofos não verifiquem a
possibilidade de comer ao mesmo tempo, já o semáforo s[i], é utilizado
para a exclusão mutua da variável state[i].</p>
<div class="code">
<pre><code>#include &lt;stdio.h&gt;
#include &lt;unistd.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;semaphore.h&gt;
#include &lt;pthread.h&gt;
#include &lt;time.h&gt;

#define N          5                  // numero de filósofos
#define LEFT      (i+4)%N             // número do filósofo a esquerda
#define RIGHT     (i+1)%N             // número do filósofo a direita
#define THINKING   0                  // filosofo pensando
#define HUNGRY     1                  // filosofo tentando pegar os garfos
#define EATING     2                  // filosofo comendo
#define TRUE       1                  // booleano verdadeiro
#define FALSE      0                  // booleano falso

int state[N];                         // vetor com os estados dos filosofos
sem_t mutex;                          // semaforo principal 
sem_t s[N];                // semaforo individual

void *thread_function (void *arg);      // função executada na chamada do thread
void filosofo(int i);            // ação do filósofo
void pega_garfos(int i);        // tentativa de pegar garfos do filósofo i
void solta_garfos(int i);        // filosofo i para de comer
void testa(int i);            // filosofo i pega os garfos de for possível
void pensa(int i);            // filosofo i pensa
void come(int i);            // filosofo i come
void imprime();                // imprime status dos filósofos

int main()
{
    int i,j,k, res;
    void * thread_result;
    pthread_t threads[N];
    printf("| FILOSOFO  1 | FILOSOFO  2 | FILOSOFO  3 | FILOSOFO  4 | FILOSOFO  5 |\n");
    //inicialização de semaforos
    if(sem_init(&amp;mutex,0,1) != 0)
    {
        perror("Problema ao inicializar semaforo principal.\n");
        exit(EXIT_FAILURE);
    }
    for(i = 0; i&lt;N ; i++)
    {
        if(sem_init(&amp;s[i],0,0) != 0)
        {    
            perror("Problema ao inicializar semaforo individual.\n");
            exit(EXIT_FAILURE);
        }
    }
    //inicialização das threads
    for(j = 0; j&lt;N ; j++)
    {
        k = j;
        if(pthread_create(threads+i,NULL,thread_function, (void *)&amp;k) != 0)
        {
            perror("Problema ao inicializar thread.\n");
            exit(EXIT_FAILURE);
        }
    }
    sleep(1);
    //espera da função main pelas threads
        if(pthread_join(threads[0],&amp;thread_result) !=0 )
        {
              perror("thread join failed");
               exit(EXIT_FAILURE);
        }
    return 0;
}
void *thread_function (void *arg)
{
filosofo(*(int *) arg);
pthread_exit(NULL);
}
void filosofo(int i)
{
    while(TRUE)
    {
        sleep(0.5f);
        pensa(i);
        pega_garfos(i);
        come(i);
        solta_garfos(i);
    }
}
void pega_garfos(int i)
{
    sem_wait(&amp;mutex);          //entra na região crítica para testar
    state[i] = HUNGRY;
    testa(i);
    sem_post(&amp;mutex);        //sai da região crítica para testar
    sem_wait(&amp;s[i]);         //entra na região crítica para a variável  state
}
void solta_garfos(int i)
{
    sem_wait(&amp;mutex);        //entra na região crítica para testar
    state[i]=THINKING;
    testa(LEFT);
    testa(RIGHT);
    sem_post(&amp;mutex);        //sai da região crítica para testar
}
void pensa(int i)
{
        srand ( time(NULL) );
        sleep(rand()%2 + 1);
}
void come(int i)    
{
        srand ( time(NULL) );
        sleep(rand()%2 + 1);
}
void testa(int i)
{
    if(state[i] == HUNGRY &amp;&amp; state[LEFT]!=EATING &amp;&amp; state[RIGHT]!=EATING)
    {
        state[i] = EATING;    
        sem_post(&amp;s[i]);    //sai da região crítica para a variável state
            imprime();
    }
}
void imprime()
{
    int l;
    for (l = 0; l &lt; 5; l++)
    {
        if(state[l]==0) printf("|   pensando  ");
        if(state[l]==1) printf("|   faminto   ");
        if(state[l]==2) printf("|   COMENDO   ");
    }
    printf("|\n");
}</code>
</pre></div>
<p>Na execução da aplicação pode-se observar que em nenhum momento filosofos vizinhos comem ao mesmo tempo:</p>
<div class="image-container aligncenter"><a href="http://ces33.wikidot.com/local--files/relas:bruno/filosofos"><img src="threads_1_arquivos/medium_002.jpg" alt="filosofos" class="image"></a></div>
<h3 id="toc6"><span>Problema dos leitores e escritores</span></h3>
<p>Este problema trata de leitores e escritores que acessam algum tipo
de dado. Este dado não pode ser lido e escrito ao mesmo tempo, sua
leitura pode ser feita por vários leitores, porém somente um escritor
pode acessar os dados ao mesmo tempo.<br>
Foi criada uma aplicação que abstrai a tentativa de acesso a um banco de dados.</p>
<p>Segue o código fonte produzido:</p>
<div class="code">
<div class="hl-main">
<pre><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdlib.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">semaphore.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">pthread.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">time.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
 
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">ESCRITORES</span><span class="hl-code">    </span><span class="hl-number">3</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">LEITORES</span><span class="hl-code">      </span><span class="hl-number">5</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-prepro">TRUE</span><span class="hl-code">          </span><span class="hl-number">1</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-prepro">FALSE</span><span class="hl-code">          </span><span class="hl-number">0</span><span class="hl-code">
 
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">escritores</span><span class="hl-brackets">[]</span><span class="hl-code"> = </span><span class="hl-brackets">{</span><span class="hl-number">1</span><span class="hl-code">, </span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">}</span><span class="hl-code">;        </span><span class="hl-comment">//escritores</span><span class="hl-code">
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">leitores</span><span class="hl-brackets">[]</span><span class="hl-code"> = </span><span class="hl-brackets">{</span><span class="hl-number">1</span><span class="hl-code">, </span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-code">, </span><span class="hl-number">4</span><span class="hl-code">, </span><span class="hl-number">5</span><span class="hl-brackets">}</span><span class="hl-code">;    </span><span class="hl-comment">//leitores</span><span class="hl-code">
</span><span class="hl-identifier">pthread_mutex_t</span><span class="hl-code"> </span><span class="hl-identifier">mutex</span><span class="hl-code">;            </span><span class="hl-comment">//semaforo que cria exclusão mutua para a variavel rc</span><span class="hl-code">
</span><span class="hl-identifier">sem_t</span><span class="hl-code"> </span><span class="hl-identifier">db</span><span class="hl-code">;                </span><span class="hl-comment">//semaforo que cria exclusão mutua para o acesso ao banco de dados</span><span class="hl-code">
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">rc</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">;                </span><span class="hl-comment">//armazena o numero de leitores no banco de dados</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">reader</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;         </span><span class="hl-comment">//função do thread de um leitor    </span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">writer</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;        </span><span class="hl-comment">//função do thread de um escritor</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">think_up_data</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">;        </span><span class="hl-comment">//criaçao de dado</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">write_data_base</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">;        </span><span class="hl-comment">//inserção de dado</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">read_data_base</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">;        </span><span class="hl-comment">//leitura de dado</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">use_data_read</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">;        </span><span class="hl-comment">// uso de dado</span><span class="hl-code">
 
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">()</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-types">void</span><span class="hl-code"> * </span><span class="hl-identifier">thread_result</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_t</span><span class="hl-code"> *</span><span class="hl-identifier">threads</span><span class="hl-code">;
    </span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code">;
 
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">sem_init</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">db</span><span class="hl-code">,</span><span class="hl-number">0</span><span class="hl-code">,</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar o semaforo do bando de dados.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_mutex_init</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar mutex.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-reserved">for</span><span class="hl-brackets">(</span><span class="hl-identifier">i</span><span class="hl-code">=</span><span class="hl-number">0</span><span class="hl-code">;</span><span class="hl-identifier">i</span><span class="hl-code">&lt;</span><span class="hl-identifier">ESCRITORES</span><span class="hl-code">;</span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">){</span><span class="hl-code">
        </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
            </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;    
        </span><span class="hl-identifier">threads</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">malloc</span><span class="hl-brackets">(</span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-brackets">))</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_create</span><span class="hl-brackets">(</span><span class="hl-identifier">threads</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-code">,</span><span class="hl-identifier">writer</span><span class="hl-code">, </span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-brackets">)(</span><span class="hl-identifier">escritores</span><span class="hl-code">+</span><span class="hl-identifier">i</span><span class="hl-brackets">))</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar thread de escritor.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">for</span><span class="hl-brackets">(</span><span class="hl-identifier">i</span><span class="hl-code">=</span><span class="hl-number">0</span><span class="hl-code">;</span><span class="hl-identifier">i</span><span class="hl-code">&lt;</span><span class="hl-identifier">LEITORES</span><span class="hl-code">;</span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">){</span><span class="hl-code">    
        </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
            </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">threads</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">malloc</span><span class="hl-brackets">(</span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-brackets">))</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_create</span><span class="hl-brackets">(</span><span class="hl-identifier">threads</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-code">,</span><span class="hl-identifier">reader</span><span class="hl-code">, </span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-brackets">)(</span><span class="hl-identifier">leitores</span><span class="hl-code">+</span><span class="hl-identifier">i</span><span class="hl-brackets">))</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar thread de leitor.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_join</span><span class="hl-brackets">(</span><span class="hl-identifier">threads</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-code">,&amp;</span><span class="hl-identifier">thread_result</span><span class="hl-brackets">)</span><span class="hl-code"> !=</span><span class="hl-number">0</span><span class="hl-code"> </span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-brackets">{</span><span class="hl-code">
              </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">thread join failed</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
               </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">reader</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">while</span><span class="hl-brackets">(</span><span class="hl-prepro">TRUE</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">pthread_mutex_lock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">rc</span><span class="hl-code"> = </span><span class="hl-identifier">rc</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">rc</span><span class="hl-code"> == </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">sem_wait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">db</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">pthread_mutex_unlock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;        
        </span><span class="hl-identifier">read_data_base</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">pthread_mutex_lock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">rc</span><span class="hl-code"> = </span><span class="hl-identifier">rc</span><span class="hl-code"> - </span><span class="hl-number">1</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">rc</span><span class="hl-code"> == </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">sem_post</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">db</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">pthread_mutex_unlock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">use_data_read</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">writer</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">while</span><span class="hl-brackets">(</span><span class="hl-prepro">TRUE</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">think_up_data</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sem_wait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">db</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">write_data_base</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sem_post</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">db</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">think_up_data</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;    
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">write_data_base</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Escritor %d escrevendo dado...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-code">,</span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;    
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Escritor %d termina de escrever...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-code">,</span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">read_data_base</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Leitor %d lendo dado...</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-code">,</span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;    
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">use_data_read</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;    
</span><span class="hl-brackets">}</span>
</pre></div>
</div>
<p>A solução satizfaz os requisitos do problema:</p>
<div class="image-container aligncenter"><a href="http://ces33.wikidot.com/local--files/relas:bruno/leitor_escritor"><img src="threads_1_arquivos/medium_004.jpg" alt="leitor_escritor" class="image"></a></div>
<h3 id="toc7"><span>Problema do barbeiro adormecido</span></h3>
<p>Alguns barbeiros desejam fazer cortes de cabelo. Sabendo que
clientes chegam a todo momento, a solução deste problema deve permitir
que os clientes sejam atendidos de forma organizada.<br>
Segue o código da aplicação que realiza os cortes de cabelo:</p>
<div class="code">
<div class="hl-main">
<pre><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdlib.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">semaphore.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">pthread.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">time.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
 
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">BARBERS</span><span class="hl-code">      </span><span class="hl-number">3</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">CADEIRAS</span><span class="hl-code">     </span><span class="hl-number">5</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">VERDADEIRO</span><span class="hl-code">   </span><span class="hl-number">1</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">FALSO</span><span class="hl-code">        </span><span class="hl-number">0</span><span class="hl-code">
 
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">barbeiros</span><span class="hl-brackets">[]</span><span class="hl-code"> = </span><span class="hl-brackets">{</span><span class="hl-number">1</span><span class="hl-code">, </span><span class="hl-number">2</span><span class="hl-code">, </span><span class="hl-number">3</span><span class="hl-brackets">}</span><span class="hl-code">;            </span><span class="hl-comment">//barbeiro</span><span class="hl-code">
</span><span class="hl-identifier">sem_t</span><span class="hl-code"> </span><span class="hl-identifier">costumers</span><span class="hl-code">;                          </span><span class="hl-comment">//semaforo que controla os clientes</span><span class="hl-code">
</span><span class="hl-identifier">sem_t</span><span class="hl-code"> </span><span class="hl-identifier">barbers</span><span class="hl-code">;                          </span><span class="hl-comment">//semaforo que controla os barbeiros</span><span class="hl-code">
</span><span class="hl-identifier">sem_t</span><span class="hl-code"> </span><span class="hl-identifier">mutex</span><span class="hl-code">;                              </span><span class="hl-comment">//semaforo que cria exclusão mutua</span><span class="hl-code">
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">esperando</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">;                </span><span class="hl-comment">//variavel que armazena a quantidade de clientes esperando</span><span class="hl-code">
 
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">barber</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;            </span><span class="hl-comment">//função da thread do barbeiro</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">costumer</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;            </span><span class="hl-comment">//função da thread do cliente</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">ganha_corte</span><span class="hl-brackets">()</span><span class="hl-code">;                </span><span class="hl-comment">//função que realiza o corte</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">corta_cabelo</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">barbeiro</span><span class="hl-brackets">)</span><span class="hl-code">;        </span><span class="hl-comment">//função que exprime a satifação do cliente em ter o cabelo cortado</span><span class="hl-code">
 
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">()</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-types">void</span><span class="hl-code"> * </span><span class="hl-identifier">thread_result</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_t</span><span class="hl-code"> *</span><span class="hl-identifier">threads</span><span class="hl-code">;
    </span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">i</span><span class="hl-code">;
 
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">sem_init</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-code">,</span><span class="hl-number">0</span><span class="hl-code">,</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar o semaforo mutex.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">sem_init</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">barbers</span><span class="hl-code">,</span><span class="hl-number">0</span><span class="hl-code">,</span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar semaforo barbers.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">sem_init</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">costumers</span><span class="hl-code">,</span><span class="hl-number">0</span><span class="hl-code">,</span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar semaforo costumers.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-reserved">for</span><span class="hl-brackets">(</span><span class="hl-identifier">i</span><span class="hl-code">=</span><span class="hl-number">0</span><span class="hl-code">;</span><span class="hl-identifier">i</span><span class="hl-code">&lt;</span><span class="hl-identifier">BARBERS</span><span class="hl-code">;</span><span class="hl-identifier">i</span><span class="hl-code">++</span><span class="hl-brackets">){</span><span class="hl-code">    
        </span><span class="hl-identifier">threads</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">malloc</span><span class="hl-brackets">(</span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-brackets">))</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_create</span><span class="hl-brackets">(</span><span class="hl-identifier">threads</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-code">,</span><span class="hl-identifier">barber</span><span class="hl-code">, </span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-brackets">)(</span><span class="hl-identifier">barbeiros</span><span class="hl-code">+</span><span class="hl-identifier">i</span><span class="hl-brackets">))</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar thread barbers.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">while</span><span class="hl-brackets">(</span><span class="hl-identifier">VERDADEIRO</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
            </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">threads</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">malloc</span><span class="hl-brackets">(</span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-brackets">))</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_create</span><span class="hl-brackets">(</span><span class="hl-identifier">threads</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-code">,</span><span class="hl-identifier">costumer</span><span class="hl-code">, </span><span class="hl-prepro">NULL</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar thread costumers.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">barber</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">while</span><span class="hl-brackets">(</span><span class="hl-identifier">VERDADEIRO</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">sem_wait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">costumers</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sem_wait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">esperando</span><span class="hl-code"> = </span><span class="hl-identifier">esperando</span><span class="hl-code"> - </span><span class="hl-number">1</span><span class="hl-code">;
        </span><span class="hl-identifier">sem_post</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">barbers</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sem_post</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">corta_cabelo</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
            </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">arg</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">costumer</span><span class="hl-code"> </span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">sem_wait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">esperando</span><span class="hl-code">&lt;</span><span class="hl-identifier">CADEIRAS</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">esperando</span><span class="hl-code"> = </span><span class="hl-identifier">esperando</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-code">;
        </span><span class="hl-identifier">sem_post</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">costumers</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sem_post</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">sem_wait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">barbers</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">ganha_corte</span><span class="hl-brackets">()</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-reserved">else</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">sem_post</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-identifier">pthread_exit</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">corta_cabelo</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">barbeiro</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Barbeiro %d: Cortei um cabelo</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-code">,</span><span class="hl-identifier">barbeiro</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">ganha_corte</span><span class="hl-brackets">()</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Cliente: Ganhei um corte de cabelo</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span>
</pre></div>
</div>
<p>Foi obtido o seguinte resultado durante a execução:</p>
<div class="image-container aligncenter"><a href="http://ces33.wikidot.com/local--files/relas:bruno/barbeiro"><img src="threads_1_arquivos/medium_005.jpg" alt="barbeiro" class="image"></a></div>
<h3 id="toc8"><span>Problema do banheiro</span></h3>
<p>Em um banheiro é proibida a entrada de homens e mulheres ao mesmo
tempo. Considerando que as mulheres e homens são vistos como threads
pela aplicação, a entrada no banheiro foi controlada por semáforos.</p>
<p>Segue o código fonte da aplicação:</p>
<div class="code">
<div class="hl-main">
<pre><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdlib.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">semaphore.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">pthread.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">time.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
 
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-prepro">TRUE</span><span class="hl-code">          </span><span class="hl-number">1</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-prepro">FALSE</span><span class="hl-code">          </span><span class="hl-number">0</span><span class="hl-code">
 
</span><span class="hl-identifier">pthread_mutex_t</span><span class="hl-code"> </span><span class="hl-identifier">mutex_h</span><span class="hl-code">;                </span><span class="hl-comment">//controla acesso a variavel mulher</span><span class="hl-code">
</span><span class="hl-identifier">pthread_mutex_t</span><span class="hl-code"> </span><span class="hl-identifier">mutex_m</span><span class="hl-code">;                </span><span class="hl-comment">//controla acesso a variavel homem    </span><span class="hl-code">
</span><span class="hl-identifier">sem_t</span><span class="hl-code"> </span><span class="hl-identifier">banheiro</span><span class="hl-code">;                        </span><span class="hl-comment">//controla acesso ao banheiro</span><span class="hl-code">
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">com_homem</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">;                    </span><span class="hl-comment">//armazena quantidade de homens no banheiro</span><span class="hl-code">
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">com_mulher</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">;                    </span><span class="hl-comment">//armazena quantidade de mulheres no banheiro    </span><span class="hl-code">
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">vazio</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">;                        </span><span class="hl-comment">//indica que o banheiro esta vazio</span><span class="hl-code">
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">k</span><span class="hl-code">=</span><span class="hl-number">0</span><span class="hl-code">;                        </span><span class="hl-comment">//usado pra criação de threads</span><span class="hl-code">
 
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">homem_quer_entrar</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">;                </span><span class="hl-comment">//função executada quando homem tenta entrar</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">homem_sai</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">;                    </span><span class="hl-comment">//função executada quando homem sai</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">mulher_quer_entrar</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">;            </span><span class="hl-comment">//função executada quando mulher tenta entrar</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">mulher_sai</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">;                </span><span class="hl-comment">//função executada quando mulher sai</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">thread_homem_function</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;            </span><span class="hl-comment">//função da thread do homem</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">thread_mulher_function</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;        </span><span class="hl-comment">//função da thread do mulher</span><span class="hl-code">
 
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">()</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">j</span><span class="hl-code">=</span><span class="hl-number">0</span><span class="hl-code">;
    </span><span class="hl-types">void</span><span class="hl-code"> * </span><span class="hl-identifier">thread_result</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_t</span><span class="hl-code"> *</span><span class="hl-identifier">threads_h</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_t</span><span class="hl-code"> *</span><span class="hl-identifier">threads_m</span><span class="hl-code">;
    </span><span class="hl-comment">//inicialização dos semáforos</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">sem_init</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">banheiro</span><span class="hl-code">,</span><span class="hl-number">0</span><span class="hl-code">,</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar o semaforo do banheiro.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
 
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_mutex_init</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex_h</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar mutex.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_mutex_init</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex_m</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar mutex.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-comment">//geração de threads</span><span class="hl-code">
    </span><span class="hl-reserved">while</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">k</span><span class="hl-code">++;
        </span><span class="hl-identifier">threads_m</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">malloc</span><span class="hl-brackets">(</span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-brackets">))</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_create</span><span class="hl-brackets">(</span><span class="hl-identifier">threads_m</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-code">,</span><span class="hl-identifier">thread_mulher_function</span><span class="hl-code">, </span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-code">&amp;</span><span class="hl-identifier">k</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar thread de mulher.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
 
        </span><span class="hl-identifier">threads_h</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">malloc</span><span class="hl-brackets">(</span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-brackets">))</span><span class="hl-code">;
        </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_create</span><span class="hl-brackets">(</span><span class="hl-identifier">threads_h</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-code">,</span><span class="hl-identifier">thread_homem_function</span><span class="hl-code">, </span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-brackets">)</span><span class="hl-code">&amp;</span><span class="hl-identifier">k</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-brackets">{</span><span class="hl-code">
            </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar thread de homem.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
            </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_join</span><span class="hl-brackets">(</span><span class="hl-identifier">threads_h</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-code">,&amp;</span><span class="hl-identifier">thread_result</span><span class="hl-brackets">)</span><span class="hl-code"> !=</span><span class="hl-number">0</span><span class="hl-code"> </span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-brackets">{</span><span class="hl-code">
              </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">thread join failed</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
               </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">homem_quer_entrar</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">2</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_mutex_lock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex_h</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">com_homem</span><span class="hl-code"> = </span><span class="hl-identifier">com_homem</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">com_homem</span><span class="hl-code"> == </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">sem_wait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">banheiro</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Homem entrou</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_mutex_unlock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex_h</span><span class="hl-brackets">)</span><span class="hl-code">;    
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">homem_sai</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">pthread_mutex_lock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex_h</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">com_homem</span><span class="hl-code"> = </span><span class="hl-identifier">com_homem</span><span class="hl-code"> - </span><span class="hl-number">1</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">com_homem</span><span class="hl-code"> == </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">sem_post</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">banheiro</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Homem saiu</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_mutex_unlock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex_h</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">mulher_quer_entrar</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">2</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_mutex_lock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex_m</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">com_mulher</span><span class="hl-code"> = </span><span class="hl-identifier">com_mulher</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">com_mulher</span><span class="hl-code"> == </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">sem_wait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">banheiro</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Mulher entrou</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_mutex_unlock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex_m</span><span class="hl-brackets">)</span><span class="hl-code">;        
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">mulher_sai</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">id</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">pthread_mutex_lock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex_m</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">com_mulher</span><span class="hl-code"> = </span><span class="hl-identifier">com_mulher</span><span class="hl-code"> - </span><span class="hl-number">1</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">com_mulher</span><span class="hl-code"> == </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">sem_post</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">banheiro</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Mulher saiu</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_mutex_unlock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex_m</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
 
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">thread_homem_function</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">homem_quer_entrar</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">homem_sai</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_exit</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">thread_mulher_function</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">mulher_quer_entrar</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;    
    </span><span class="hl-identifier">mulher_sai</span><span class="hl-brackets">(</span><span class="hl-code">*</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_exit</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">)</span><span class="hl-code">;
</span><span class="hl-brackets">}</span>
</pre></div>
</div>
<p>Na execução da solução apresentada foi obtido o seguinte resultado:</p>
<h3 id="toc9"><span>Problema das mensagens</span></h3>
<p>Neste problema, mensagens pre-determinadas são enviadas de uma
pessoa para a outra (como as usadas em alguns celulares). Esse problema
é análogo ao primeiro problema resolvido com o uso de pipes, porém,
desta vez, a solução foi feita usando semáforos e substituido o <em>buffer</em> por um vetor chamado correio.</p>
<div class="code">
<div class="hl-main">
<pre><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdio.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">unistd.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">stdlib.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">semaphore.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">pthread.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">time.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
</span><span class="hl-prepro">#include </span><span class="hl-quotes">&lt;</span><span class="hl-string">string.h</span><span class="hl-quotes">&gt;</span><span class="hl-code">
 
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">N</span><span class="hl-code">          </span><span class="hl-number">100</span><span class="hl-code">            </span><span class="hl-comment">//tamanho da caiza de correio</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-prepro">TRUE</span><span class="hl-code">       </span><span class="hl-number">1</span><span class="hl-code">            </span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-prepro">FALSE</span><span class="hl-code">      </span><span class="hl-number">0</span><span class="hl-code">
</span><span class="hl-prepro">#define</span><span class="hl-code"> </span><span class="hl-identifier">M</span><span class="hl-code">        </span><span class="hl-number">6</span><span class="hl-code">            </span><span class="hl-comment">// numero de mensagens</span><span class="hl-code">
 
</span><span class="hl-identifier">pthread_mutex_t</span><span class="hl-code"> </span><span class="hl-identifier">mutex</span><span class="hl-code">;            </span><span class="hl-comment">//protege caixa de correio</span><span class="hl-code">
</span><span class="hl-identifier">sem_t</span><span class="hl-code"> </span><span class="hl-identifier">empty</span><span class="hl-code">;                </span><span class="hl-comment">//protege retirada de caixa de correio vazia</span><span class="hl-code">
</span><span class="hl-identifier">sem_t</span><span class="hl-code"> </span><span class="hl-identifier">full</span><span class="hl-code">;                </span><span class="hl-comment">//protege colocada na caixa de correio cheia</span><span class="hl-code">
</span><span class="hl-types">char</span><span class="hl-code">* </span><span class="hl-identifier">mensagens</span><span class="hl-brackets">[</span><span class="hl-number">20</span><span class="hl-brackets">]</span><span class="hl-code"> = </span><span class="hl-brackets">{</span><span class="hl-code"> </span><span class="hl-quotes">"</span><span class="hl-string">Olá</span><span class="hl-quotes">"</span><span class="hl-code"> , </span><span class="hl-quotes">"</span><span class="hl-string">Tchau</span><span class="hl-quotes">"</span><span class="hl-code"> , </span><span class="hl-quotes">"</span><span class="hl-string">Feliz Aniversário</span><span class="hl-quotes">"</span><span class="hl-code"> , </span><span class="hl-quotes">"</span><span class="hl-string">Desculpa</span><span class="hl-quotes">"</span><span class="hl-code"> , </span><span class="hl-quotes">"</span><span class="hl-string">Tenha um bom dia</span><span class="hl-quotes">"</span><span class="hl-code"> , </span><span class="hl-quotes">"</span><span class="hl-string">Estou com saudades</span><span class="hl-quotes">"</span><span class="hl-brackets">}</span><span class="hl-code">;
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">correio</span><span class="hl-brackets">[</span><span class="hl-identifier">N</span><span class="hl-brackets">]</span><span class="hl-code">;
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">inicio</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">;                </span><span class="hl-comment">//inicio da fila no vetor correio</span><span class="hl-code">
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">fim</span><span class="hl-code"> = </span><span class="hl-number">0</span><span class="hl-code">;                </span><span class="hl-comment">//fim da fila no vetor correio</span><span class="hl-code">
 
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">cria_mensagem</span><span class="hl-brackets">()</span><span class="hl-code">;            </span><span class="hl-comment">//cria uma mensagem</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">send</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-brackets">)</span><span class="hl-code">;        </span><span class="hl-comment">//envia uma mensagem</span><span class="hl-code">
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">receive</span><span class="hl-brackets">()</span><span class="hl-code">;                </span><span class="hl-comment">//recebe uma mensagem</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">usa_mensagem</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-brackets">)</span><span class="hl-code">;    </span><span class="hl-comment">//usa uma mensagem</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">recebe_mensagem</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code">* </span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;       </span><span class="hl-comment">//função da thread que recebe mensagem</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">envia_mensagem</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code">* </span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">;    </span><span class="hl-comment">//função da thread que envia mensagem</span><span class="hl-code">
 
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">main</span><span class="hl-brackets">()</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">j</span><span class="hl-code">=</span><span class="hl-number">0</span><span class="hl-code">;
    </span><span class="hl-types">void</span><span class="hl-code"> * </span><span class="hl-identifier">thread_result</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_t</span><span class="hl-code"> *</span><span class="hl-identifier">threads_envia</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_t</span><span class="hl-code"> *</span><span class="hl-identifier">threads_recebe</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_mutex_init</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar mutex.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">sem_init</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">full</span><span class="hl-code">,</span><span class="hl-number">0</span><span class="hl-code">,</span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar o semaforo full.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">sem_init</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">empty</span><span class="hl-code">,</span><span class="hl-number">0</span><span class="hl-code">,</span><span class="hl-identifier">N</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar o semaforo empty.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">threads_envia</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">malloc</span><span class="hl-brackets">(</span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_create</span><span class="hl-brackets">(</span><span class="hl-identifier">threads_envia</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-code">,</span><span class="hl-identifier">envia_mensagem</span><span class="hl-code">, </span><span class="hl-prepro">NULL</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar thread que envia mensagem.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-identifier">threads_recebe</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-code">*</span><span class="hl-brackets">)</span><span class="hl-code"> </span><span class="hl-identifier">malloc</span><span class="hl-brackets">(</span><span class="hl-reserved">sizeof</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_t</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_create</span><span class="hl-brackets">(</span><span class="hl-identifier">threads_recebe</span><span class="hl-code">,</span><span class="hl-prepro">NULL</span><span class="hl-code">,</span><span class="hl-identifier">recebe_mensagem</span><span class="hl-code">, </span><span class="hl-prepro">NULL</span><span class="hl-brackets">)</span><span class="hl-code"> != </span><span class="hl-number">0</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
        </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Problema ao inicializar thread que recebe mensagem.</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
        </span><span class="hl-reserved">if</span><span class="hl-brackets">(</span><span class="hl-identifier">pthread_join</span><span class="hl-brackets">(</span><span class="hl-identifier">threads_recebe</span><span class="hl-brackets">[</span><span class="hl-number">0</span><span class="hl-brackets">]</span><span class="hl-code">,&amp;</span><span class="hl-identifier">thread_result</span><span class="hl-brackets">)</span><span class="hl-code"> !=</span><span class="hl-number">0</span><span class="hl-code"> </span><span class="hl-brackets">)</span><span class="hl-code">
        </span><span class="hl-brackets">{</span><span class="hl-code">
              </span><span class="hl-identifier">perror</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">thread join failed</span><span class="hl-quotes">"</span><span class="hl-brackets">)</span><span class="hl-code">;
               </span><span class="hl-identifier">exit</span><span class="hl-brackets">(</span><span class="hl-identifier">EXIT_FAILURE</span><span class="hl-brackets">)</span><span class="hl-code">;
        </span><span class="hl-brackets">}</span><span class="hl-code">
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-number">0</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">envia_mensagem</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code">* </span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-reserved">while</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-code">;
    </span><span class="hl-identifier">mensagem</span><span class="hl-code"> = </span><span class="hl-identifier">cria_mensagem</span><span class="hl-brackets">()</span><span class="hl-code">;
    </span><span class="hl-identifier">sem_wait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">empty</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_mutex_lock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">send</span><span class="hl-brackets">(</span><span class="hl-identifier">mensagem</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_mutex_unlock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sem_post</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">full</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> *</span><span class="hl-identifier">recebe_mensagem</span><span class="hl-brackets">(</span><span class="hl-types">void</span><span class="hl-code">* </span><span class="hl-identifier">arg</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-code">;
    </span><span class="hl-reserved">while</span><span class="hl-brackets">(</span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">
    </span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-code">;    
    </span><span class="hl-identifier">sem_wait</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">full</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_mutex_lock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">mensagem</span><span class="hl-code"> = </span><span class="hl-identifier">receive</span><span class="hl-brackets">()</span><span class="hl-code">;
    </span><span class="hl-identifier">pthread_mutex_unlock</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">mutex</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-identifier">sleep</span><span class="hl-brackets">(</span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-number">2</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">sem_post</span><span class="hl-brackets">(</span><span class="hl-code">&amp;</span><span class="hl-identifier">empty</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-identifier">usa_mensagem</span><span class="hl-brackets">(</span><span class="hl-identifier">mensagem</span><span class="hl-brackets">)</span><span class="hl-code">;
    </span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">cria_mensagem</span><span class="hl-brackets">()</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-code">;
    </span><span class="hl-identifier">srand</span><span class="hl-brackets">(</span><span class="hl-identifier">time</span><span class="hl-brackets">(</span><span class="hl-prepro">NULL</span><span class="hl-brackets">))</span><span class="hl-code">;
    </span><span class="hl-identifier">mensagem</span><span class="hl-code"> = </span><span class="hl-identifier">rand</span><span class="hl-brackets">()</span><span class="hl-code">%</span><span class="hl-identifier">M</span><span class="hl-code">;
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Mensagem criada: %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-code">, </span><span class="hl-identifier">mensagens</span><span class="hl-brackets">[</span><span class="hl-identifier">mensagem</span><span class="hl-brackets">])</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">send</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">correio</span><span class="hl-brackets">[</span><span class="hl-identifier">fim</span><span class="hl-brackets">]</span><span class="hl-code"> = </span><span class="hl-identifier">mensagem</span><span class="hl-code">;
    </span><span class="hl-identifier">fim</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">fim</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">%</span><span class="hl-identifier">N</span><span class="hl-code">;    
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">receive</span><span class="hl-brackets">()</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-code">;
    </span><span class="hl-identifier">mensagem</span><span class="hl-code"> = </span><span class="hl-identifier">correio</span><span class="hl-brackets">[</span><span class="hl-identifier">inicio</span><span class="hl-brackets">]</span><span class="hl-code">;
    </span><span class="hl-identifier">inicio</span><span class="hl-code"> = </span><span class="hl-brackets">(</span><span class="hl-identifier">inicio</span><span class="hl-code"> + </span><span class="hl-number">1</span><span class="hl-brackets">)</span><span class="hl-code">%</span><span class="hl-identifier">N</span><span class="hl-code">;
    </span><span class="hl-reserved">return</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-code">;
</span><span class="hl-brackets">}</span><span class="hl-code">
</span><span class="hl-types">void</span><span class="hl-code"> </span><span class="hl-identifier">usa_mensagem</span><span class="hl-brackets">(</span><span class="hl-types">int</span><span class="hl-code"> </span><span class="hl-identifier">mensagem</span><span class="hl-brackets">)</span><span class="hl-code">
</span><span class="hl-brackets">{</span><span class="hl-code">
    </span><span class="hl-identifier">printf</span><span class="hl-brackets">(</span><span class="hl-quotes">"</span><span class="hl-string">Mensagem recebida: %s</span><span class="hl-special">\</span><span class="hl-string">n</span><span class="hl-quotes">"</span><span class="hl-code">,</span><span class="hl-identifier">mensagens</span><span class="hl-brackets">[</span><span class="hl-identifier">mensagem</span><span class="hl-brackets">])</span><span class="hl-code">;
</span><span class="hl-brackets">}</span>
</pre></div>
</div>
<p>Segue o resultado obtido:</p>
<div class="image-container aligncenter"><a href="http://ces33.wikidot.com/local--files/relas:bruno/send_receive"><img src="threads_1_arquivos/medium_003.jpg" alt="send_receive" class="image"></a></div>

					</div>
					
															
		<div id="adsense-below-pagea" style="margin: 20px auto; display: block; float: none; visibility: visible; text-align: center;">
<script type="text/javascript"><!--
google_ad_client = "pub-8290351116363959";
/* Wikidot_top_link */
google_ad_slot = "9510090502";
google_ad_width = 468;
google_ad_height = 15;
//-->
</script>
<script type="text/javascript" src="threads_1_arquivos/show_ads.js">
</script><script>google_protectAndRun("ads_core.google_render_ad", google_handleError, google_render_ad);</script><ins style="border: medium none ; margin: 0pt; padding: 0pt; display: inline-table; height: 15px; position: relative; visibility: visible; width: 468px;"><ins style="border: medium none ; margin: 0pt; padding: 0pt; display: block; height: 15px; position: relative; visibility: visible; width: 468px;"><iframe allowtransparency="true" hspace="0" id="google_ads_frame2" marginheight="0" marginwidth="0" name="google_ads_frame" src="threads_1_arquivos/ads_002.html" style="left: 0pt; position: absolute; top: 0pt;" vspace="0" scrolling="no" width="468" frameborder="0" height="15"></iframe></ins></ins>
</div>
						
				

										
										
					<!-- google_ad_section_end -->
					
					<!-- google_ad_section_start(weight=ignore) -->
					
					<div style="clear: both; height: 1px; font-size: 1px;"></div>
																	<div id="page-info">page_revision: 33, last_edited: <span style="visibility: visible; display: inline;" class="odate">8 May 2009, 07:28 BRT (85 days ago)</span></div>
<div id="page-options-bottom" class="page-options-bottom">
	<a href="javascript:;" id="edit-button">edit</a><a href="javascript:;" id="tags-button">tags</a>
	<a href="javascript:;" id="history-button">history</a> 
	<a href="javascript:;" id="files-button">files</a> <a href="javascript:;" id="print-button">print</a> <a href="javascript:;" id="site-tools-button">site tools</a><a href="javascript:;" id="more-options-button">+&nbsp;options</a> 
</div>
<div id="page-options-bottom-2" class="page-options-bottom" style="display: none;">
	<a href="javascript:;" id="edit-sections-button">edit sections</a>
	<a href="javascript:;" id="edit-append-button">append</a>
	<a href="javascript:;" id="edit-meta-button">edit meta</a>
	<a href="javascript:;" id="watchers-button">who watches</a> 
	<a href="javascript:;" id="backlinks-button">backlinks</a> 
	<a href="javascript:;" id="view-source-button">view source</a> 
	<a href="javascript:;" id="parent-page-button">parent</a> 
	<a href="javascript:;" id="page-block-button">block</a> 	
	<a href="javascript:;" id="rename-move-button">rename</a> 
	<a href="javascript:;" id="delete-button">delete</a> 
</div>
<div id="page-options-area-bottom">
</div>
			
										
					<div id="action-area" style="display: none;"></div>
				</div>
			</div>
			
			
			
	 		<div id="footer" style="display: block; visibility: visible;">
	 					 			<div class="options" style="display: block; visibility: visible;">
			 			<a href="http://www.wikidot.com/doc" id="wikidot-help-button">
				 			help				 		</a>
			 			|
				 		<a href="http://www.wikidot.com/legal:terms-of-service" id="wikidot-tos-button">
				 			terms of service				 		</a>
			 			|
				 		<a href="http://www.wikidot.com/legal:privacy-policy" id="wikidot-privacy-button">
				 			privacy				 		</a>
			 			|
				 		<a href="javascript:;" id="bug-report-button" onclick="WIKIDOT.page.listeners.pageBugReport(event)">
				 			report a bug				 		</a>
			 			|
				 		<a href="javascript:;" id="abuse-report-button" onclick="WIKIDOT.page.listeners.flagPageObjectionable(event)">
				 			flag as objectionable				 		</a>
		 			</div>
			 				 				Hosted by <a href="http://www.wikidot.com/">Wikidot.com</a> — 
		 						 					<a href="http://www.wikidot.com/new-site">get your free wiki now!</a>
		 						 					 					 			 		</div>
	 				 		<div id="license-area" class="license-area">
		 									Unless stated otherwise Content of this page is licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 License</a>
														</div>
						
									

						
			
			<div id="extrac-div-1"><span></span></div><div id="extrac-div-2"><span></span></div><div id="extrac-div-3"><span></span></div>
			
						  				<div id="footer-bar">
  <div>
        </div>
  <h2></h2>
  
      <div class="unit">
      <div class="inner">
        <a target="_blank" class="image" href="http://tcinbiology.wikidot.com/">
          <img class="thumbnail" alt="" src="threads_1_arquivos/80_004.jpg">
        </a>
        <h3><a target="_blank" href="http://tcinbiology.wikidot.com/">Διδασκαλία Βιολογίας με ΤΠΕ</a></h3>
        <div class="desc">          
          
        </div>
      </div>
    </div>
      <div class="unit">
      <div class="inner">
        <a target="_blank" class="image" href="http://www.hackercurriculum.org/">
          <img class="thumbnail" alt="" src="threads_1_arquivos/80.jpg">
        </a>
        <h3><a target="_blank" href="http://www.hackercurriculum.org/">Hacker Curriculum</a></h3>
        <div class="desc">          
          What hackers learn that the rest of us don't
        </div>
      </div>
    </div>
      <div class="unit">
      <div class="inner">
        <a target="_blank" class="image" href="http://exodus-rp.wikidot.com/">
          <img class="thumbnail" alt="" src="threads_1_arquivos/80_003.jpg">
        </a>
        <h3><a target="_blank" href="http://exodus-rp.wikidot.com/">Exodus</a></h3>
        <div class="desc">          
          Not just a mass movement of people
        </div>
      </div>
    </div>
      <div class="unit">
      <div class="inner">
        <a target="_blank" class="image" href="http://pfeffies.wikidot.com/">
          <img class="thumbnail" alt="" src="threads_1_arquivos/80_002.jpg">
        </a>
        <h3><a target="_blank" href="http://pfeffies.wikidot.com/">SV Pfefferwerk Damen</a></h3>
        <div class="desc">          
          
        </div>
      </div>
    </div>
  </div>

  				 	</div>
	 	
	</div>
	<!-- These extra divs/spans may be used as catch-alls to add extra imagery. -->
	<div id="extra-div-1"><span></span></div><div id="extra-div-2"><span></span></div><div id="extra-div-3"><span></span></div>
	<div id="extra-div-4"><span></span></div><div id="extra-div-5"><span></span></div><div id="extra-div-6"><span></span></div>
	</div>
 	
 	 	
 	<div id="page-options-bottom-tips" style="display: none;">
 		
 	</div>
 	<div id="page-options-bottom-2-tips" style="display: none;">
 		
 		
 		
 		<div id="discuss-button-hovertip">
 			If you want to discuss contents of this page - this is the easiest way to do it. 		</div>
 		
 		
 		
 		
 		
 		
 			 		
	 		
	 		
	 		
	 		
 		 	</div>
 	
 	<!-- google_ad_section_end -->
 	
 	<div id="account-notifications-dummy" style="display: none;"></div>
 	
 	<div style="display: none;" id="dummy-ondomready-block"></div>
	
		
	<script src="threads_1_arquivos/urchin.js" type="text/javascript"></script>
	<script type="text/javascript">
		_uff = false;
		_uacct = "UA-68540-5";
		_udn="wikidot.com"; 
		urchinTracker();
	</script>

<!-- Start Quantcast tag -->
<script type="text/javascript">
_qoptions={
qacct:"p-edL3gsnUjJzw-"
};
</script>
<script type="text/javascript" src="threads_1_arquivos/quant.js"></script><div style="position: absolute; z-index: 100; top: 0pt; width: 100%;" id="odialog-hovertips"><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="edit-button-hovertip"><div class="content">
 			Click here to edit contents of this page. 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="edit-sections-button-hovertip"><div class="content">
	 		Click here to toggle editing of individual sections of the page (if possible).
	 		Watch headings for an "edit" link when available. 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="edit-append-button-hovertip"><div class="content">
 			Append content without editing the whole page source. 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="history-button-hovertip"><div class="content">
 			Check out how this page has evolved in the past. 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="files-button-hovertip"><div class="content">
 			View and manage file attachments for this page. 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="site-tools-button-hovertip"><div class="content">
 			A few useful tools to manage this Site. 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="backlinks-button-hovertip"><div class="content">
 				See pages that link to and include this page. 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="rename-move-button-hovertip"><div class="content">
 			Change the name (also URL address, possibly the category) of the page. 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="view-source-button-hovertip"><div class="content">
 			View wiki source for this page without editing. 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="parent-page-button-hovertip"><div class="content">	
 			View/set parent page (used for creating breadcrumbs and structured layout). 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none; left: 980px; top: 14090px;" class="hovertip" id="abuse-report-button-hovertip"><div class="content">
	 				Notify administrators if there is objectionable content in this page.	 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="bug-report-button-hovertip"><div class="content">
				Something does not work as expected? Find out what you can do.	 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="wikidot-help-button-hovertip"><div class="content">
	 			General Wikidot.com documentation and help section.	 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="wikidot-tos-button-hovertip"><div class="content">
	 			Wikidot.com Terms of Service - what you can, what you should not etc.	 		</div></div><div style="border: 1px solid black; visibility: visible; opacity: 0.9999; position: absolute; display: none;" class="hovertip" id="wikidot-privacy-button-hovertip"><div class="content">
	 				Wikidot.com Privacy Policy. 			
	 		</div></div></div>
<noscript>
<img src="http://pixel.quantserve.com/pixel/p-edL3gsnUjJzw-.gif"
style="display: none;" border="0" height="1" width="1"
alt="Quantcast"/>
</noscript>
<!-- End Quantcast tag -->


		
	  </body></html>